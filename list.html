<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>勤怠一覧</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    table { border-collapse: collapse; width: 100%; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
    td.month { cursor: pointer; background: #eef; }
    td.month:hover { background: #ddf; }
    td.month.active { background: #88f; color: white; }
    button { margin: 0.5em; }
    label { margin-right: 1em; }
  </style>
</head>
<body>
  <h1>勤怠一覧</h1>

  <!-- 年と並び順の選択 -->
  <label>年を選択: 
    <select id="year-select"></select>
  </label>

  <label>並び順: 
    <select id="sort-order">
      <option value="asc">古い順</option>
      <option value="desc">新しい順</option>
    </select>
  </label>
  
  <div id="month-picker"></div>

  <table>
    <thead><tr><th>日付</th><th>出勤コマ</th><th>事務時間（分）</th><th>削除</th></tr></thead>
    <tbody id="attendance-body"></tbody>
  </table>

  <br>
  <a href="index.html">メニューに戻る</a>

  <script>
    const yearSelect = document.getElementById('year-select');
    const sortOrderSelect = document.getElementById('sort-order');
    const monthPicker = document.getElementById('month-picker');
    const tbody = document.getElementById('attendance-body');
    const months = ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];

    // 勤怠データから入力のあった年を取得
    function getYearsWithData() {
      const data = JSON.parse(localStorage.getItem('attendance') || '[]');
      const years = new Set();
      data.forEach(entry => {
        const year = entry.date.split('-')[0];
        years.add(year);
      });
      return Array.from(years).sort();
    }

    // 年選択プルダウンを更新
    function updateYearSelect() {
      const years = getYearsWithData();
      yearSelect.innerHTML = '';
      years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      });

      // デフォルトで今年の年を選択
      if (years.includes(new Date().getFullYear().toString())) {
        yearSelect.value = new Date().getFullYear();
      }
      renderMonthPicker();
    }

    // 月ピッカー作成
    function renderMonthPicker() {
      const selectedYear = yearSelect.value;
      monthPicker.innerHTML = '';
      const table = document.createElement('table');
      const header = document.createElement('thead');
      header.innerHTML = `<tr><th colspan="3">${selectedYear}</th></tr>`;
      table.appendChild(header);

      const tbodyPicker = document.createElement('tbody');
      for (let i = 0; i < 4; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < 3; j++) {
          const m = i * 3 + j;
          const cell = document.createElement('td');
          cell.className = 'month';
          cell.textContent = months[m];
          cell.dataset.value = `${selectedYear}-${String(m + 1).padStart(2, '0')}`;
          cell.onclick = () => {
            document.querySelectorAll('td.month').forEach(td => td.classList.remove('active'));
            cell.classList.add('active');
            showAttendance(cell.dataset.value);
          };
          row.appendChild(cell);
        }
        tbodyPicker.appendChild(row);
      }
      table.appendChild(tbodyPicker);
      monthPicker.appendChild(table);
    }

    // 勤怠表示（並び順対応）
    function showAttendance(month) {
      const data = JSON.parse(localStorage.getItem('attendance') || '[]');
      const filtered = data.filter(row => row.date.startsWith(month));

      const sortOrder = sortOrderSelect.value;
      filtered.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
      });

      tbody.innerHTML = '';
      filtered.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = 
          `<td>${row.date}</td>
           <td>${row.periods.join(', ')}</td>
           <td>${row.officeMinutes}</td>
           <td><button onclick="deleteEntry(${index})">削除</button></td>`;
        tbody.appendChild(tr);
      });
    }

    // 削除処理
    function deleteEntry(index) {
      const data = JSON.parse(localStorage.getItem('attendance') || '[]');
      if (confirm("この打刻を削除しますか？")) {
        data.splice(index, 1);
        localStorage.setItem('attendance', JSON.stringify(data));
        location.reload();
      }
    }

    // 並び順変更で再表示
    sortOrderSelect.addEventListener('change', () => {
      const currentMonth = document.querySelector('td.month.active')?.dataset.value;
      if (currentMonth) showAttendance(currentMonth);
    });

    // 年選択変更で月ピッカー再描画
    yearSelect.addEventListener('change', renderMonthPicker);

    // 初期化
    updateYearSelect();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="icon" href="meiko.png" type="image/x-icon">
  <link rel="apple-touch-icon" href="meiko.png">
  <meta charset="UTF-8">
  <title>çµ¦ä¸ç¢ºèª</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    table { border-collapse: collapse; width: 100%; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
    td.month { cursor: pointer; background: #eef; }
    td.month:hover { background: #ddf; }
    .rate-table { margin-top: 2em; width: auto; }
    .rate-table th { background: #f0f0f0; }
  </style>
</head>
<body>
  <h1>çµ¦ä¸ç¢ºèª</h1>

  <!-- ç·æ”¯çµ¦é¡ã®è¡¨ç¤º -->
  <h2>ç·æ”¯çµ¦é¡ï¼ˆå…¨æœŸé–“ï¼‰</h2>
  <div id="total-salary-display"></div>

  <label>å¹´ã‚’é¸æŠ: 
    <select id="year-select"></select>
  </label>

  <div id="month-picker"></div>
  <div id="salary-display"></div>

  <h2>ç‰¹åˆ¥çµ¦å†…è¨³</h2>
  <div id="special-reasons-list"></div>

  <br>
  <a href="index.html">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>

  <!-- ğŸ”¹çµ¦ä¸å˜ä¾¡ã®è¡¨ç¤ºæ¬„ -->
  <h2>çµ¦ä¸é¡ä¸€è¦§</h2>
  <table class="rate-table">
    <thead>
      <tr><th>æœŸé–“</th><th>ã‚³ãƒçµ¦</th><th>è¶…é</th><th>äº‹å‹™çµ¦</th></tr>
    </thead>
    <tbody>
      <tr><td>ã€œ2025å¹´9æœˆ</td><td>2,183å††</td><td>2,729å††</td><td>18å††</td></tr>
      <tr><td>2025å¹´10æœˆã€œ</td><td>2,448å††</td><td>3,060å††</td><td>20å††</td></tr>
    </tbody>
  </table>

  <script>
    const monthPicker = document.getElementById('month-picker');
    const display = document.getElementById('salary-display');
    const specialReasonsList = document.getElementById('special-reasons-list');
    const yearSelect = document.getElementById('year-select');
    const months = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];

    function getYearsWithData() {
      const data = JSON.parse(localStorage.getItem('attendance') || '[]');
      const years = new Set();
      data.forEach(entry => {
        const year = entry.date.split('-')[0];
        years.add(year);
      });
      return Array.from(years).sort();
    }

    function updateYearSelect() {
      const years = getYearsWithData();
      yearSelect.innerHTML = '';
      years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      });
      if (years.includes(new Date().getFullYear().toString())) {
        yearSelect.value = new Date().getFullYear();
      }
      renderMonthPicker();
    }

    yearSelect.addEventListener('change', renderMonthPicker);
    updateYearSelect();

    function renderMonthPicker() {
      const selectedYear = yearSelect.value;
      monthPicker.innerHTML = '';
      const table = document.createElement('table');
      const header = document.createElement('thead');
      header.innerHTML = `<tr><th colspan="3">${selectedYear}</th></tr>`;
      table.appendChild(header);

      const tbodyPicker = document.createElement('tbody');
      for (let i = 0; i < 4; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < 3; j++) {
          const m = i * 3 + j;
          const cell = document.createElement('td');
          cell.className = 'month';
          cell.textContent = months[m];
          cell.dataset.value = `${selectedYear}-${String(m + 1).padStart(2, '0')}`;
          cell.onclick = () => showSalary(cell.dataset.value);
          row.appendChild(cell);
        }
        tbodyPicker.appendChild(row);
      }
      table.appendChild(tbodyPicker);
      monthPicker.appendChild(table);
    }

    function getRatesForMonth(month) {
      const [year, m] = month.split('-').map(x => parseInt(x, 10));
      if (year > 2025 || (year === 2025 && m >= 10)) {
        return { koma: 2448, extra: 3060, office: 20 };
      } else {
        return { koma: 2183, extra: 2729, office: 18 };
      }
    }

    function showSalary(month) {
      const data = JSON.parse(localStorage.getItem('attendance') || '[]');
      const filtered = data.filter(row => row.date.startsWith(month));
      const rates = getRatesForMonth(month);

      let totalPeriods = 0;
      let totalMinutes = 0;
      let totalSpecial = 0;
      const specialReasons = [];

      filtered.forEach(row => {
        totalPeriods += (row.periods || []).length;
        totalMinutes += row.officeMinutes || 0;
        totalSpecial += parseInt(row.specialAmount || '0', 10);
        if (row.specialReason) {
          specialReasons.push(`${row.specialReason} (${parseInt(row.specialAmount || '0', 10).toLocaleString()}å††)`);
        }
      });

      let salary = 0;
      if (totalPeriods === 6) {
        salary = (5 * rates.koma) + (1 * rates.extra) + (totalMinutes * rates.office) + totalSpecial;
      } else {
        salary = totalPeriods * rates.koma + totalMinutes * rates.office + totalSpecial;
      }

      display.innerHTML = 
        `<table>
          <thead><tr><th>å‡ºå‹¤ã‚³ãƒ</th><th>äº‹å‹™æ™‚é–“ï¼ˆåˆ†ï¼‰</th><th>çµ¦ä¸</th></tr></thead>
          <tbody>
            <tr>
              <td>${totalPeriods}</td>
              <td>${totalMinutes}</td>
              <td>${salary.toLocaleString()}å††</td>
            </tr>
          </tbody>
        </table>`;

      specialReasonsList.innerHTML = specialReasons.length > 0 
        ? `<ul>${specialReasons.map(reason => `<li>${reason}</li>`).join('')}</ul>`
        : `<p>ç‰¹åˆ¥çµ¦ãªã—</p>`;
    }

    // ç·æ”¯çµ¦é¡ï¼ˆå…¨æœŸé–“åˆ†ï¼‰ã‚’è¡¨ç¤º
    function showTotalSalary() {
      const data = JSON.parse(localStorage.getItem('attendance') || '[]');

      let totalSalary = 0;

      data.forEach(row => {
        const date = row.date;
        const month = date.slice(0, 7);
        const rates = getRatesForMonth(month);

        const periods = (row.periods || []).length;
        const minutes = row.officeMinutes || 0;
        const special = parseInt(row.specialAmount || '0', 10);

        let salary = 0;
        if (periods === 6) {
          salary = (5 * rates.koma) + (1 * rates.extra) + (minutes * rates.office) + special;
        } else {
          salary = periods * rates.koma + minutes * rates.office + special;
        }

        totalSalary += salary;
      });

      document.getElementById('total-salary-display').innerHTML = 
        `<p><strong>${totalSalary.toLocaleString()}å††</strong></p>`;
    }

    // åˆæœŸè¡¨ç¤ºæ™‚ã«å®Ÿè¡Œ
    showTotalSalary();
  </script>
</body>
</html>
